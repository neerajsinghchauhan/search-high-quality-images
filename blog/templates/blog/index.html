{% extends 'blog/base.html' %}

{% block content %}
{% load static %}
    <h1>Search for Blog Images</h1>

    <!-- Search form -->
    <form method="GET" action="{% url 'index' %}">
        <input type="text" name="q" placeholder="Search for images..." value="{{ query }}">
        <button type="submit" class="btn btn-primary">Search</button>
    </form>

    <hr>

    <!-- Display images fetched from Unsplash API -->
     <!-- Image Gallery -->
     <div id="image-container" class="row">
        {% for image in images %}
            <div class="col-md-4 mb-4">
                <div class="card">
                    <img src="{{ image.urls.regular }}" class="card-img-top" alt="{{ image.alt_description }}" data-bs-toggle="modal" data-bs-target="#imageModal" data-full="{{ image.urls.full }}" onclick="showModal(this)" style="width: 100%; height: auto;">
                    <div class="card-body">
                        <p class="card-text">{{ image.alt_description|default:"No description" }}</p>
                        <!-- Download Button -->
                        <a class="btn btn-primary btn-sm" href="{% url 'download_image' %}?image_url={{ image.urls.full }}" download>Download</a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Loader (hidden initially) -->
    <div id="loader" class="text-center my-3" style="display: none;">
        <img src="{% static 'css/loader.gif' %}" alt="Loading...">
    </div>
</div>
<!-- Modal for displaying full-size image -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalLabel">Image Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modal-image" src="" alt="Large Image" class="img-fluid">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS and custom JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    
    // Show the modal with the full-size image
    function showModal(imageElement) {
            const fullImageUrl = imageElement.getAttribute('data-full');
            const modalImage = document.getElementById('modal-image');
            modalImage.src = fullImageUrl;
    } 

    let page = 2;  // Start with the second page since the first page is already loaded
    let query = "{{ query }}";  // The current search query

    // Function to load more images when the user scrolls near the bottom of the page
    function loadMoreImages() {
        let loader = document.getElementById('loader');
        loader.style.display = 'block';  // Show the loader

        let xhr = new XMLHttpRequest();
        xhr.open('GET', `?q=${query}&page=${page}`, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.onload = function () {
            if (xhr.status === 200) {
                let data = JSON.parse(xhr.responseText);
                let imageContainer = document.getElementById('image-container');
                data.images.forEach(function (image) {
                    let imageCard = `
                        <div class="col-md-4 mb-4">
                            <div class="card">
                                <!-- NEW: Click to view in larger modal (dynamic images) -->
                                <img src="${image.url}" class="card-img-top" alt="${image.alt}" data-bs-toggle="modal" data-bs-target="#imageModal" data-full="${image.url}" onclick="showModal(this)">
                                
                                <div class="card-body">
                                    <p class="card-text">${image.alt || 'No description'}</p>
                                    <a class="btn btn-primary btn-sm" href="/download_image?image_url=${image.url}" download>Download</a>
                                </div>
                            </div>
                        </div>
                    `;
                    imageContainer.insertAdjacentHTML('beforeend', imageCard);
                });
                loader.style.display = 'none';  // Hide the loader
                page++;  // Increment the page number
            }
        };
        xhr.send();
    }

    // Event listener for scroll
    window.addEventListener('scroll', function () {
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            loadMoreImages();
        }
    });
</script>
</body>
</html>
{% endblock %}
